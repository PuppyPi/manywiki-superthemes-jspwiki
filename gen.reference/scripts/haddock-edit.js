Array.implement({hsv2rgb:function(){var e=this,t,n,r,i,s,o=e[0]/360,u=e[1]/100,a=e[2]/100;return u?(o=o>1?0:6*o,s=o|0,n=a*(1-u),r=a*(1-u*(o-s)),i=a+n-r,t=s==0?[a,i,n]:s==1?[r,a,n]:s==2?[n,a,i]:s==3?[n,r,a]:s==4?[i,n,a]:[a,n,r]):t=[a,a,a],t.map(function(e){return.5+e*255|0})},rgb2hsv:function(){var e=this,t=0,n=0,r=255,i=e[0]/r,s,o=e[1]/r,u,a=e[2]/r,f,l=[i,o,a].max(),c=l-[i,o,a].min();return c&&(n=c/l,r=c/2,s=((l-i)/6+r)/c,u=((l-o)/6+r)/c,f=((l-a)/6+r)/c,t=i==l?f-u:o==l?1/3+s-f:2/3+u-s,t<0&&(t+=1),t>1&&(t-=1)),[t*360,n*100,l*100]}});var Dialog=new Class({Implements:[Events,Options],options:{cssShow:"show",cssClass:"",styles:{},relativeTo:document.body},initialize:function(e){var t=this,n;this.setClass(".dialog",e),this.setOptions(e),e=t.options,n=t.element=e.dialog||t.build(e),n.getElements(".close").addEvent("click",t.hide.bind(t)),n.getStyle("position")=="absolute"&&e.draggable&&new Drag(n,{handle:(t.get(".caption")||n).setStyle("cursor","move")}),t[e.showNow?"show":"hide"]()},toElement:function(){return this.element},get:function(e){return this.element.getElement(e)},hasClass:function(e){return this.element.hasClass(e)},ifClass:function(e,t,n){var r=this.element;return r&&r.ifClass(e,t,n),this},setClass:function(e,t){t.cssClass=e+(t.cssClass||"")},destroy:function(){this.element.destroy()},show:function(){this.fireEvent("beforeOpen",this);if(!this.options.draggable||!this.hasPosition)this.setPosition(),this.hasPosition=!0;return this.element.addClass(this.options.cssShow),this.fireEvent("open",this)},hide:function(){return this.hasPosition&&(this.fireEvent("beforeClose",this).element.removeClass(this.options.cssShow),this.fireEvent("close",this)),this},isVisible:function(){return this.element.hasClass(this.options.cssShow)},toggle:function(){return this[this.isVisible()?"hide":"show"]()},action:function(e){this.fireEvent("action",e),this.options.autoClose&&this.hide()},build:function(e){var t=this.element=["div"+e.cssClass,{styles:e.styles},["a.close",{html:"&#215;"},"div.body"]].slick().inject(document.body);return e.relativeTo&&t.inject($(e.relativeTo),"before"),this.setBody(e.body),e.caption&&this.setCaption(e.caption),t},setBody:function(e){var t=this.get(".body")||this.element,n=typeOf(e);return t.empty(),n=="string"&&t.set("html",e),n=="element"&&t.adopt(e),n=="elements"&&t.adopt(e),this},setCaption:function(e){var t=this.get(".caption")||"div.caption".slick().inject(this.element,"top"),n=typeOf(e);return t.empty(),n=="string"&&t.set("html",e),n=="element"&&t.adopt(e),this},setValue:function(e){return console.log("DIALOG  "+e),this.setBody(e)},setPosition:function(e){var t=window,n,r,i,s,o=this.element;return e||(e=this.options.relativeTo),s=e&&"getCoordinates"in e?e:document.id(e),s?(s=s.getCoordinates(),r=s.left,i=s.bottom):(n=t.getScroll(),t=t.getSize(),s=o.getCoordinates(),r=n.x+t.x/2-s.width/2,i=n.y+t.y/2-s.height/2),o.setPosition({x:r,y:i}),this}});Dialog.Buttons=new Class({Extends:Dialog,options:{buttons:[],autoClose:!0},initialize:function(e){this.setClass(".buttons",e),this.parent(e),this.setButtons(this.options.buttons)},setButtons:function(e){var t=this,n=t.get(".btn-group")||"div.btn-group".slick().inject(t.element);return n.empty().adopt(e.map(function(e){return"a.btn.btn-default.btn-sm".slick({html:e.localize(),events:{click:t.action.bind(t,e)}})})),t}}),Dialog.Color=new Class({Extends:Dialog,options:{color:"#ffffff",resize:{x:[96,256]}},initialize:function(e){var t=this,n,r=e.showNow,i=t.setHSV.bind(this);this.setClass(".color",e),e.caption="span.color".slick(),e.body=["div.cursor","div.zone"].slick(),n=t.cursor=e.body[0],e.showNow=!1,t.parent(e),new Drag(n,{handle:n.getNext(),style:!1,snap:0,onStart:i,onDrag:i}),t.setValue(),r&&t.show()},setValue:function(e){return e=(e||this.options.color).hexToRgb(!0)||[255,255,255],this.hsv=e.rgb2hsv(),this.moveCursor()},setHSV:function(e,t){var n=this,r=n.get(".body").getCoordinates(),i=[t.page.x-r.left,t.page.y-r.top],s=r.width,o=s/2,u=o/2,a=i[0]-o,f=s-i[1]-o,l=Math.sqrt(Math.pow(a,2)+Math.pow(f,2)),c=Math.atan2(a,f)/(Math.PI*2);n.hsv=[c>0?c*360:c*360+360,l<u?l/u*100:100,l>=u?Math.max(0,1-(l-u)/u)*100:100],n.moveCursor(),n.fireEvent("drag",n.getHex())},getHex:function(){return this.hsv.hsv2rgb().rgbToHex()},action:function(){this.parent(this.getHex())},show:function(){return this.parent().moveCursor()},moveCursor:function(){var e=this,t=e.hsv,n=e.getHex(),r=e.get(".body").getSize().x/2,i=t[0]/360*Math.PI*2,s=(t[1]+(100-t[2]))/100*(r/2);return e.get(".color").set({html:n,styles:{color:(new Color(n)).invert().hex,background:n}}),e.cursor.setStyles({left:Math.abs(Math.sin(i)*s+r),top:Math.abs(Math.cos(i)*s-r)}),e}}),Dialog.Selection=new Class({Extends:Dialog,options:{cssClass:"dialog selection",match:"^=",autoClose:!0},initialize:function(e){var t=this;t.setClass(".selection",e),t.selected=e.selected||"",t.parent(e),t.element.addEvent("click:relay(.item)",function(e){e.stop(),t.action(this.get("title"))})},setBody:function(e){var t=this,n=[];return e||(e=t.options.body),typeOf(e)=="string"&&(e=e.split("|")),typeOf(e)=="array"&&(e=e.reduce(function(e,t){return e[t]=t.escapeHtml(),e},{})),typeOf(e)=="object"&&(Object.each(e,function(e,t){n.push(e==""?"li.divider":"li.item",{html:e,title:t})}),e=["ul",n].slick()),typeOf(e)=="element"&&t.parent(e).setValue(t.selected),t},setValue:function(e){var t=this,n="selected",r,i=".item[title"+t.options.match+e+"]";return r=t.get("."+n),r&&r.removeClass(n),r=t.get(i),r&&r.addClass(n),t[n]=e,t},getValue:function(){return this.selected},action:function(e){this.setValue(e).parent(e)}}),Dialog.Font=new Class({Extends:Dialog.Selection,options:{fonts:{"arial, helvetica, sans-serif":"Sans Serif","times new roman, serif":"Serif",monospace:"Fixed Width","arial black, sans-serif":"Wide","arial narrow, sans-serif":"Narrow",divider1:"","comic sans ms":"Comic Sans","courier new":"Courier New",garamond:"Garamond",georgia:"Georgia",helvetica:"Helvetica","HelveticaNeue-Light":"Helvetica Neue Light",impact:"Impact","times new roman":"Times New Roman",tahoma:"Tahoma","trebuchet ms":"Trebuchet",verdana:"Verdana"}},initialize:function(e){var t=this;t.setClass(".font",e),e.body=e.fonts||t.options.fonts,t.parent(e),t.element.getElements(".item").each(function(e){e.setStyle("font-family",e.get("title"))})}}),Dialog.Chars=new Class({Extends:Dialog.Selection,options:{chars:["lsquo|rsquo|ldquo|rdquo|lsaquo|rsaquo|laquo|raquo|apos|quot|sbquo|bdquo","ndash|mdash|sect|para|dagger|Dagger|amp|lt|gt|copy|reg|trade","rarr|rArr|bull|middot|deg|plusmn|brvbar|times|divide|frac14|frac12|frac34","hellip|micro|cent|pound|euro|iquest|iexcl|uml|acute|cedil|circ|tilde","Agrave|Aacute|Acirc|Atilde|Auml|Aring|AElig|Ccedil|Egrave|Eacute|Ecirc|Euml","Igrave|Iacute|Icirc|Iuml|ETH|Ntilde|Ograve|Oacute|Ocirc|Otilde|Ouml|Oslash","OElig|Scaron|Ugrave|Uacute|Ucirc|Uuml|Yacute|Yuml|THORN|szlig|agrave|aacute","acirc|atilde|auml|aring|aelig|ccedil|egrave|eacute|ecirc|euml|igrave|iacute","icirc|iuml|eth|ntilde|ograve|oacute|ocirc|otilde|ouml|oslash|oelig|scaron","ugrave|uacute|ucirc|uuml|yacute|yuml|thorn|ordf|ordm|alpha|Omega|infin","not|sup2|sup3|permil|larr|uarr|darr|harr|hArr|crarr|loz|diams"]},initialize:function(e){this.setClass(".chars",e),this.parent(e)},setBody:function(){var e=[];return this.options.chars.map(function(t){var n=[];t.split("|").each(function(e){n.push("td.item[title=&"+e+";]",{html:"&"+e+";"})}),e.push("tr",n)}),this.parent(["table",e].slick())}}),Dialog.Find=new Class({Extends:Dialog,Binds:["find","replace"],options:{draggable:!0,controls:{f:"[name=tbFIND]",r:"[name=tbREPLACE]",h:".tbHITS",re:"[name=tbREGEXP]",i:"[name=tbMatchCASE]",one:"[name=replace]",all:"[name=replaceall]",tsel:"[name=tbTEXTSEL]"},data:{selection:function(){},get:function(){},set:function(){}}},initialize:function(e){var t=this.setOptions(e),n=t.options.dialog,r;this.setClass(".find",e),r=t.controls=Object.map(t.options.controls,function(e){return n.getElement(e)}),t.parent(e),r.f.addEvents({keyup:t.find,focus:t.find}),n.addEvents({"change:relay([type=checkbox])":function(){r.f.focus()},"click:relay(button)":t.replace})},show:function(){var e=this.controls,t=this.options.data.selection();e.tsel.ifClass(t=="","hidden"),e.tsel.value=t,this.parent(),e.f.focus()},find:function(){var e=this,t=e.controls,n=t.f.value,r,i,s="disabled";n!=""&&(r=e.buildRE(n),r instanceof RegExp&&(r=e.options.data.get().match(e.buildRE(n,!0)),r&&(r=r.length))),t.h&&(t.h.innerHTML=r||""),i=+r?"erase":"set",t.r[i](s,s),t.one[i](s,s),t.all[i](s,s),t.f.focus()},replace:function(e){var t=this,n=t.controls,r=n.r,i=n.f,s=t.options.data;s.set(s.get().replace(t.buildRE(i.value,e.target==n.all),r?r.value:"")),i.focus()},buildRE:function(e,t){var n=this.controls,r=n.re&&n.re.checked,i=t?"g":"",s=n.i&&n.i.checked?"":"i";try{return RegExp(r?e:e.escapeRegExp(),i+s+"m")}catch(o){return"<span title='"+o+"'>!#@</span>"}}});var Textarea=new Class({Implements:[Options,Events],initialize:function(e,t){var n=this,r=n.ta=document.id(e);return n.setOptions(t),n.taShadow="div[style=position:absolute;visibility:hidden;overflow:auto]".slick().setStyles(r.getStyles("font-family0font-size0line-height0text-indent0padding-top0padding-right0padding-bottom0padding-left0border-left-width0border-right-width0border-left-style0border-right-style0white-space0word-wrap".split(0))),this},toElement:function(){return this.ta},focus:function(){this.ta.focus()},getValue:function(){return this.ta.value},setValue:function(e){return this.ta.value=e,this.setSelectionRange(0,0),this},slice:function(e,t){return this.ta.value.slice(e,t)},indexOf:function(e,t){return this.ta.value.indexOf(e,t)},getFromStart:function(){return this.slice(0,this.getSelectionRange().start)},getTillEnd:function(){return this.slice(this.getSelectionRange().end)},getSelection:function(){var e=this.getSelectionRange();return this.slice(e.start,e.end)},setSelectionRange:function(e,t){var n=this.ta,r,i,s;return t||(t=e),n.setSelectionRange?n.setSelectionRange(e,t):(r=n.value,i=r.slice(e,t-e).replace(/\r/g,"").length,e=r.slice(0,e).replace(/\r/g,"").length,s=n.createTextRange(),s.collapse(!0),s.moveEnd("character",e+i),s.moveStart("character",e),s.select()),n.fireEvent("change"),this},getSelectionRange:function(){var e=this.ta,t=0,n=0,r,i,s,o;return e.selectionStart!=null?(t=e.selectionStart,n=e.selectionEnd):(r=document.selection.createRange(),r&&r.parentElement()==e&&(i=r.duplicate(),s=e.value,o=s.length-s.match(/[\n\r]*$/)[0].length,i.moveToElementText(e),i.setEndPoint("StartToEnd",r),n=o-i.text.length,i.setEndPoint("StartToStart",r),t=o-i.text.length)),{start:t,end:n,thin:t==n}},setSelection:function(){var e=Array.from(arguments).join("").replace(/\r/g,""),t=this.ta,n=t.scrollTop,r,i,s,o;return t.selectionStart!=null?(r=t.selectionStart,i=t.selectionEnd,s=t.value,t.value=s.slice(0,r)+e+s.substr(i),t.selectionStart=r,t.selectionEnd=r+e.length):(t.focus(),o=document.selection.createRange(),o.text=e,o.collapse(1),o.moveStart("character",-e.length),o.select()),t.focus(),t.scrollTop=n,t.fireEvent("change"),this},insertAfter:function(){var e=Array.from(arguments).join("");return this.setSelection(e).setSelectionRange(this.getSelectionRange().start+e.length)},isCaretAtStartOfLine:function(){var e=this.getSelectionRange().start;return e<1||this.ta.value.charAt(e-1).test(/[\n\r]/)},isCaretAtEndOfLine:function(){var e=this.getSelectionRange().end;return e==this.ta.value.length||this.slice(e-1,e+1).test(/[\n\r]/)},getCoordinates:function(e){var t=this.ta,n=this.taShadow.inject(t,"before"),r=t.value.replace(/[<>&]/g,"X"),i,s,o,u,a;return e==undefined&&(e=this.getSelectionRange().end),i=n.set({styles:{width:t.offsetWidth,height:t.getStyle("height")},html:r.slice(0,e)+"<i>A</i>"+r.slice(e+1)}).getElement("i"),s=t.offsetTop+i.offsetTop-t.scrollTop,o=t.offsetLeft+i.offsetLeft-t.scrollLeft,u=i.offsetWidth,a=i.offsetHeight,{top:s,left:o,width:u,height:a,right:o+u,bottom:s+a}},onDragAndDrop:function(e,t){function i(r,i){var s=e(i);s&&(r.stopPropagation(),r.preventDefault(),n.insertAfter(s),t&&t())}var n=this,r=this.ta;r.addEventListener("dragover",function(e){var t=e.dataTransfer;t&&(t.dropEffect="copy")}),r.addEventListener("drop",function(e){var t=e.dataTransfer;t&&t.files.length==0&&i(e,t)}),r.addEventListener("paste",function(e){i(e,e.clipboardData)})}});!function(e,t){function n(e,n,r){var i,s=typeof n=="function",u=t.createTreeWalker(e,4,null,!1);while(i=u.nextNode())s?n(i):o(i,n,r);return e}function r(e,t,n){return(e.querySelectorAll(t)||[]).forEach(n),e}function i(e,t,n){return r(e,t,function(e){s(e,n.xsubs(e.textContent))})}function s(e,n){e.parentNode.replaceChild(t.createTextNode(n),e)}function o(e,t,n){e.textContent=e.textContent.replace(t,n)}function u(e){e.parentNode.removeChild(e)}function a(e,t){var n=[];while(e=e.parentElement)e.matches(t)&&n.push(e);return n}function f(e){var t=e.href,n=e.textContent;n=n.replace(/\[\[/g,"&lsqb;").replace(/\]/g,"&rsqb;"),s(e," ["+n+"|"+t+"] ")}function l(e){var t="\n",n,r;for(n=0;r=e.cells[n];n++)t+=(r.tagName.test(/th/i)?"||":"|")+(r.textContent.trim()||"&nbsp;");s(e,t)}function c(e){var t=e.parentElement.tagName,n=t.test(/ul/i)?"*":t.test(/ol/i)?"#":"*",r=a(e,"ul,ol").length;(e=e.firstChild)&&o(e,/.*/,"\n"+n.repeat(r)+" "+"$&")}e.url2links=function(e){return e?e.split("\r\n").map(function(e){return"\n["+e+"]\n"}):e},e.html2wiki=function(e){if(!e)return;var t="div".slick({html:e});return n(t,/\[/g,"[["),r(t,"style",u),i(t,"b,strong","__{0}__"),i(t,"i","''{0}''"),i(t,"sup","%%sup {0}/%"),i(t,"sub","%%sub {0}/%"),r(t,"a",f),i(t,"tt","{{{0}}}"),i(t,"pre,code","\n{{{\n{0}\n}}}\n"),i(t,"hr","\n----\n"),i(t,"br"," \\\\ "),i(t,"h1,h2","\n!!! {0}\n"),i(t,"h3","\n!! {0}\n"),i(t,"h4","\n! {0}\n"),i(t,"dl dt","\n;{0}:"),r(t,"li",c),r(t,"tr",l),i(t,"p","\n{0}\n"),t.textContent.replace(/^\s*(.*)\s*$/,"$1")+"\n"}}(Wiki,document),!function(){function e(e){var t=e.btns,n="disabled";t.undo&&t.undo.ifClass(!e.undo[0],n),t.redo&&t.redo.ifClass(!e.redo[0],n)}function t(t,n){t=this[t],n=this[n],t[0]&&(n[n.length]=this.getState(),this.putState(t.pop())),e(this)}this.Undoable=new Class({initializeUndoable:function(n,r){var i=this,s=i.undo=[];i.redo=[],i.btns=n,e(i),r=r||40,i.addEvents({beforeChange:function(t){s[s.length]=t||i.getState(),i.redo=[],s[r]&&s.shift(),e(i)},undo:t.pass(["undo","redo"],i),redo:t.pass(["redo","undo"],i)})}})}();var Snipe=new Class({Implements:[Options,Events,Undoable],Binds:["sync","shortcut","keystroke","suggest","action"],options:{tab:"    ",snippets:{},directsnips:{},sectionCursor:"all",sectionParser:function(){return{}}},initialize:function(e,t){t=this.setOptions(t).options,this.initializeUndoable(t.undoBtns);var n=this,r=t.container||$(e).form,i=n.textarea=new Textarea(e);n.directsnips=new Snipe.Snips(i,t.directsnips),n.snippets=new Snipe.Snips(i,t.snippets),n.snippets.dialogs.find=[Dialog.Find,{data:{selection:function(){return i.getSelection()},get:function(){var t=i.getSelection();return t==""?e.value:t},set:function(t){var r=i.getSelectionRange();n.fireEvent("beforeChange"),r.thin?e.value=t:i.setSelection(t),n.fireEvent("change")}}}],n.commands=new Snipe.Commands(r,{onOpen:function(){e.focus()},onClose:function(){e.focus()},onAction:n.action,dialogs:n.snippets.dialogs,relativeTo:i}),t.dragAndDrop&&i.onDragAndDrop(t.dragAndDrop,function(){n.fireEvent("change")}),n.reset(),e.addEvents({keydown:n.keystroke,keypress:n.keystroke,keyup:n.suggest.debounce(),click:n.suggest.debounce(),input:function(){n.fireEvent("change")}.debounce()}),r.addEvent("keydown",n.shortcut)},toElement:function(){return this.textarea.toElement()},get:function(e){return"value"==e?this.textarea.getValue():/mainarea|textarea/.test(e)?this[e]:/snippets|directsnips|autosuggest|tabcompletion|smartpairs/.test(e)?this.options[e]:null},set:function(e,t){return e=="value"?(this.textarea.setValue(t),this.fireEvent("beforeChange"),this.textarea.focus()):/snippets|directsnips|autosuggest|tabcompletion|smartpairs/.test(e)&&(this.options[e]=t),this.fireEvent("change")},shortcut:function(e){var t,n;if(e.shift||e.control||e.meta||e.alt)t=(e.shift?"shift+":"")+(e.control?"control+":"")+(e.meta?"meta+":"")+(e.alt?"alt+":"")+e.key,console.log("shortcut ",t),n=this.snippets.keys[t],n&&(e.stop(),this.commands.action(n))},keystroke:function(e){if(e.type=="keydown"){if(e.key.length==1)return}else{if(!e.event.which)return;e.key=String.fromCharCode(e.code).toLowerCase()}var t=this,n=t.textarea,r=e.key,i=n.getSelectionRange();n.focus(),/up|down|esc/.test(r)?t.reset():/tab|enter|delete|backspace/.test(r)?t[r](e,n,i):t.smartPairs(e,n,i)},enter:function(e,t){this.reset();var n=t.getFromStart().match(/(?:^|\r?\n)([ \t]+)(.*)$/);!e.shift&&n&&n[2]!=""&&(e.stop(),t.insertAfter("\n"+n[1]))},backspace:function(e,t,n){if(n.thin&&n.start>0){var r=t.getValue().charAt(n.start-1),i=this.directsnips.get(r);i&&i.snippet==t.getValue().charAt(n.start)&&t.setSelectionRange(n.start,n.start+1).setSelection("")}},"delete":function(e,t,n){var r=this.options.tab;n.thin&&!t.getTillEnd().indexOf(r)&&(e.stop(),t.setSelectionRange(n.start,n.start+r.length).setSelection(""))},tab:function(e,t,n){var r=this,i;e.stop();if(r.options.tabcompletion&&n.thin&&(i=r.snippets.match()))return t.setSelectionRange(n.start-i.length,n.start).setSelection(""),r.commands.action(i);r.tab2spaces(e,t,n)},tab2spaces:function(e,t,n){var r=this.options.tab,i=t.getSelection(),s=t.getFromStart(),o=t.isCaretAtStartOfLine();i.indexOf("\n")>-1?(o&&(i="\n"+i),e.shift?i=i.replace(RegExp("\n"+r,"g"),"\n"):i=i.replace(/\n/g,"\n"+r),t.setSelection(o?i.slice(1):i)):e.shift?s.test(r+"$")&&t.setSelectionRange(n.start-r.length,n.start).setSelection(""):t.setSelection(r).setSelectionRange(n.start+r.length)},hasContext:function(){return!!this.context.snip},setContext:function(e,t){this.context={snip:e,suggest:t}},reset:function(){console.log("Snipe:reset",this.context),this.context=null,this.textarea.focus(),this.commands.close()},smartPairs:function(e,t,n){var r,i=e.key;this.options.smartpairs&&(r=this.directsnips.get(i))&&(e.stop(),t.setSelection(i,t.getSelection(),r.snippet).setSelectionRange(n.start+1,n.end+1))},suggest:function(){var e;if(this.options.autosuggest){if(e=this.snippets.matchSuggest())return console.log("Snipe.suggest ",e),this.setContext(null,e),this.commands.action(e.cmd,e.lback);this.reset()}},action:function(e){function f(e){return e.replace(/~\{/g,"{")}var t=this,n=Array.slice(arguments,1),r=t.snippets.get(e),i=t.textarea,s,o,u=r.suggest?n.join():r.snippet,a=r.suggest&&t.context&&t.context.suggest;console.log("Snipe:action ",e,"snippet=",u,"args=",n,"suggest=",a);if(!r)return;r.event?t.fireEvent(r.event,arguments):(t.fireEvent("beforeChange"),a&&(u=t.suggestAction(i,u,a.lback,a.match)),(o=u.match(/(^|[\S\s]*[^~])\{([^!{}][^{}]*)\}([\S\s]*)/))?t.injectXL(i,u,f(o[1]),o[2],f(o[3])):(s=i.getSelectionRange(),u=f(u),t.inject(i,u,s.start+(s.thin?u.length:0),s.thin?0:u.length))),t.reset(),t.fireEvent("change"),t.suggest.delay(1,t)},suggestAction:function(e,t,n,r){var i=e.getSelectionRange().start,s=r.length;return t.startsWith(n)?(t=t.slice(n.length),s-=n.length):i-=n.length,e.setSelectionRange(i,i+s),t},injectXL:function(e,t,n,r,i){var s=e.getSelectionRange(),o=s.start;s.thin||(r=e.getSelection(),console.log("injectXL: ",r,n,i),r.startsWith(n)&&r.endsWith(i)?(console.log("TOGGLE: pfx/sfx matched inside the selection",s.start,s.end),r=r.slice(n.length,-i.length),n=i=""):e.getFromStart().endsWith(n)&&e.getTillEnd().startsWith(i)&&(console.log("TOGGLE: pfx/sfx matched outside the selection",s.start,s.end),o-=n.length,e.setSelectionRange(o,s.end+i.length),n=i="")),this.inject(e,n+r+i,o+n.length,r.length)},inject:function(e,t,n,r){var i=e.getFromStart(),s=i.split(/\r?\n/).pop(),o=s.match(/^\s+/);console.log("inject: ",t,n,r),t.test(/^\n/)&&i.test(/(^|[\n\r]\s*)$/)&&(console.log("collapse leading \\n",t),t=t.slice(1),n--),t.test(/\n$/)&&e.getTillEnd().test(/^\s*[\n\r]/)&&(console.log("collapse trailing \\n",t),t=t.slice(0,-1),n--),o&&(t=t.replace(/\n/g,"\n"+o[0])),e.setSelection(t).setSelectionRange(n,n+r)},getState:function(){var e=this.textarea,t=e.toElement();return{value:t.get("value"),cursor:e.getSelectionRange(),scrollTop:t.scrollTop,scrollLeft:t.scrollLeft}},putState:function(e){var t=this,n=t.textarea,r=n.toElement();t.reset(),r.value=e.value,r.scrollTop=e.scrollTop,r.scrollLeft=e.scrollLeft,n.setSelectionRange(e.cursor.start,e.cursor.end),t.fireEvent("change"),t.suggest()}});Snipe.Snips=new Class({Implements:Events,initialize:function(e,t){var n=this,r,i,s,o,u=navigator.platform.match(/mac/i)?"meta+":"control+";n.workarea=e,n.keys={},n.dialogs={},n.snips=t,n.suggestions={};for(r in t){i=$.toFunction(t[r])(e,r),typeOf(i)=="string"&&(i={snippet:i});if(s=i.key)s.contains("+")||(s=u+s),n.keys[s.toLowerCase()]=r;if(o=i.suggest)typeOf(o)=="string"&&(i.suggest={lback:RegExp(o+"$"),match:RegExp("^"+o)}),n.suggestions[r]=i;i[r]&&(n.dialogs[r]=i[r]),i.dialog&&(n.dialogs[r]=i.dialog),t[r]=i}},match:function(){var e,t=this.workarea.getFromStart();for(e in this.snips)if(t.endsWith(e))return e;return!1},matchSuggest:function(){var e,t,n,r,i,s,o=this.suggestions,u=this.workarea,a=u.getSelectionRange(),f=u.getFromStart();for(e in o){t=o[e];if(this.inScope(t,f)){s=t.suggest,s.lback?(n=f.match(s.lback),n&&(n=n.getLast(),r=u.slice(a.start-n.length).match(s.match),r&&(i={lback:n,match:r.getLast()}))):i=$.toFunction(s)(u,a,f);if(i)return i.cmd=e,i}}return!1},get:function(e){var t=this,n=t.snips[e];return n&&n.alias&&(n=t.snips[n.alias]),n&&t.inScope(n,t.workarea.getFromStart())?n:!1},inScope:function(e,t){function o(e,i){for(n in e){r=t.lastIndexOf(n);if(r>-1&&t.indexOf(e[n],r)==-1)return i}return!i}var n,r,i=e.scope,s=e.nscope;return i?typeOf(i)=="function"?i(this.textarea):o(i,!0):s?o(s):!0}}),Snipe.Commands=new Class({Implements:[Events,Options],options:{cmds:"data-cmd"},dlgs:{},btns:{},dialogs:{},initialize:function(e,t){var n=this.setOptions(t),r=n.options.cmds,i,s,o=t.dialogs||{};e.addEvent("click:relay(["+r+"])",function(e){var t=this.get(r),i=n.dlgs[t];i?i.toggle():n.action(t),this.matches("input")||e.stop()}),e.getElements("["+r+"]").each(function(u){i=u.get(r),n.btns[i]=u;if(s=e.getElement(".dialog."+i))o[i]||(o[i]=[Dialog,{}]),t=o[i][1],t.dialog=s.inject(document.body),t.relativeTo=u}),n.addDialogs(o)},addDialogs:function(e){var t,n,r=this.dialogs;for(n in e)r[n]&&console.log("Snipe.Commands addDialogs() - warning: double registration of => "+n),t=r[n]=e[n],instanceOf(t,Dialog)&&this.attach(t,n)},attach:function(e,t){var n=this,r=function(e){n.fireEvent("action",[t,e])};return n.dlgs[t]=e.addEvents({open:n.openDialog.bind(n,t),close:n.closeDialog.bind(n,t),action:r,drag:r})},action:function(e,t){var n=this,r="active",i=n.btns[e],s;if(!i||!i.matches(".disabled"))n.dialogs[e]?(s=n.dlgs[e]||n.createDialog(e),t!=null&&s.setValue(t),s.show()):(i&&i.addClass(r),n.fireEvent("action",[e,t]),i&&i.removeClass(r))},createDialog:function(e){var t=$.toFunction(this.dialogs[e])();return typeOf(t)!="array"&&(t=[Dialog.Selection,{body:t}]),t[1].relativeTo||(t[1].relativeTo=this.options.relativeTo||document.body),t[1].autoClose=!1,this.attach(new t[0](t[1]),e)},openDialog:function(e){var t=this,n=t.activeDlg,r=t.dlgs[e],i=t.btns[e];n&&n!=r&&n.hide(),t.activeDlg=t.dlgs[e],i&&i.addClass("active"),t.fireEvent("open",e)},closeDialog:function(e){var t=this,n=t.btns[e];t.dlgs[e]==t.activeDlg&&(t.activeDlg=null),n&&n.removeClass("active"),t.fireEvent("close",e)},close:function(){var e=this.activeDlg;e&&e.hide()}}),Snipe.Sections=new Class({Implements:[Events],Binds:["show","update","action"],options:{all:"( all )".localize(),sections:".sections",startOfPage:"Start of Page".localize()},initialize:function(e,t){var n=this;n.snipe=e,n.main=t.main,n.parser=t.parser,t.menu&&(n.list=t.menu.addEvent("click:relay(a)",n.action)),n.parse(),n.action(location.search),n.menu(),e.addEvent("change",n.update)},parse:function(){this.sections=this.parser(this.main.value)},menu:function(){var e=[],t=this.list,n=this.options,r=this.current,i=this.sections,s=function(t,n){e.push("li"+(n==r?".active":""),["a.text-indent-"+t.depth+".section"+n,{html:t.title}])};t&&(s({depth:0,title:n.all},-2),i[0]&&(i[0].start>0&&s({depth:0,title:n.startOfPage},-1),e.push("li.divider"),i.each(s)),t.empty().adopt(e.slick()),t.getParent().ifClass(r>=-1,"section-selected"))},update:function(){var e=this,t=e.main,n=e.snipe.get("value"),r=t.value;n.slice(-1)!="\n"&&(n+="\n"),n!=r.slice(e.begin,e.end)&&(t.value=r.slice(0,e.begin)+n+r.slice(e.end),e.end=e.begin+n.length,e.parse()),e.menu()},action:function(e){var t=this,n=t.main.value,r=t.sections,i=0,s=n.length;return e&&(e.target&&(e=e.target.className),e=parseInt((e.match(/section=?(-?\d+)/)||[,-2])[1]),e==-1?s=r[0].start:e>=0&&r[e]&&(i=r[e].start,r[e+1]&&(s=r[e+1].start)),t.current=e),t.begin=i,t.end=s,t.snipe.set("value",n.slice(i,s)),!1}})